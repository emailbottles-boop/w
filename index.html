<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>The Fractured Sky VTT v4.0 - Complete Edition</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <!-- PeerJS -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/minimap.css">
</head>
<body>
    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-title">‚öîÔ∏è THE FRACTURED SKY</div>
            <div class="welcome-subtitle">Ultimate Virtual Tabletop v4.0 - Complete Edition</div>
            <div class="welcome-buttons">
                <button class="welcome-btn welcome-btn-primary" onclick="showDMLogin()">üé≠ Create Room (DM)</button>
                <button class="welcome-btn welcome-btn-secondary" onclick="showPlayerLogin()">üë§ Join Room (Player)</button>
                <button class="welcome-btn welcome-btn-secondary" onclick="showDMRejoinModal()">üîÑ Rejoin Session (DM)</button>
            </div>
        </div>
    </div>

    <!-- DM Login Modal -->
    <div class="modal" id="dmModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üßô</div>
                <div class="modal-title">Dungeon Master</div>
            </div>
            <form onsubmit="dmLogin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmUser" placeholder="Wizard" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmPass" placeholder="FracturedSky2025!" required>
                </div>
                <div class="error" id="dmError">Invalid credentials</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">LOGIN & CREATE ROOM</button>
                <button type="button" class="btn" onclick="closeDMModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- DM Rejoin Modal -->
    <div class="modal" id="dmRejoinModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üîÑ</div>
                <div class="modal-title">Rejoin DM Session</div>
            </div>
            <form onsubmit="dmRejoin(event)">
                <div class="form-group">
                    <label>USERNAME</label>
                    <input type="text" id="dmRejoinUser" placeholder="Wizard" required>
                </div>
                <div class="form-group">
                    <label>PASSWORD</label>
                    <input type="password" id="dmRejoinPass" placeholder="FracturedSky2025!" required>
                </div>
                <div class="form-group">
                    <label>ROOM CODE (Your Session ID)</label>
                    <input type="text" id="dmRejoinSessionId" placeholder="Paste the EXACT Room Code from before you refreshed" required style="font-family: monospace;">
                    <p style="font-size: 0.75rem; color: var(--gold); margin-top: 0.5rem; background: rgba(251, 191, 36, 0.1); padding: 0.5rem; border-radius: 4px;">
                        ‚ö° <strong>IMPORTANT:</strong> Use the SAME Room Code to keep your session alive!<br>
                        ‚Ä¢ Same code = Players stay connected<br>
                        ‚Ä¢ Same code = Continue where you left off<br>
                        ‚Ä¢ Works for 30 minutes after refresh
                    </p>
                </div>
                <div class="error" id="dmRejoinError">Invalid credentials or session not found</div>
                <div class="success" id="dmRejoinSuccess">Reconnecting to your session...</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">üîÑ REJOIN MY SESSION</button>
                <button type="button" class="btn" onclick="closeDMRejoinModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Player Login Modal -->
    <div class="modal" id="playerModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">üë§</div>
                <div class="modal-title">Join as Player</div>
            </div>
            <form onsubmit="playerLogin(event)">
                <div class="form-group">
                    <label>YOUR NAME</label>
                    <input type="text" id="playerName" placeholder="Enter character name" required>
                </div>
                <div class="form-group">
                    <label>ROOM CODE</label>
                    <input type="text" id="roomCodeInput" placeholder="Paste full room code" required>
                </div>
                <div class="error" id="playerError">Connection failed</div>
                <div class="success" id="playerSuccess">Request sent! Waiting for DM approval...</div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">REQUEST TO JOIN</button>
                <button type="button" class="btn" onclick="closePlayerModal()" style="width: 100%; margin-top: 0.5rem;">Cancel</button>
            </form>
        </div>
    </div>

    <!-- Main Header -->
    <div class="header">
        <div class="title">‚öîÔ∏è THE FRACTURED SKY</div>
        <div class="header-actions">
            <div class="campaign-badge" id="roomCodeSection" style="display: none; cursor: pointer;" onclick="copyRoomCode()">
                Room: <span id="roomCode">----</span>
            </div>
            <button class="btn" id="dmControlsBtn" onclick="toggleDMPanel()" style="display: none;">
                üé≠ DM Controls
            </button>
        </div>
    </div>

    <!-- Connection Tab -->
    <div class="connection-tab-container" id="connectionTabContainer" style="display: none;">
        <div class="connection-tab" id="connectionTab" onclick="toggleConnectionPanel()">
            <div class="connection-indicator" id="connectionIndicator"></div>
            <span class="connection-status-text">Connecting...</span>
        </div>
    </div>

    <!-- Connection Panel -->
    <div class="connection-panel" id="connectionPanel">
        <div class="connection-content">
            <div class="connection-section" id="roomCodeSection2">
                <h3>üîë Room Code</h3>
                <div class="room-code" id="roomCode2" onclick="copyRoomCode()">Click to copy</div>
            </div>
            <div class="connection-section">
                <h3>üë• Connected Users</h3>
                <div class="user-list" id="userList"></div>
            </div>
            <div class="connection-section" id="pendingSection" style="display: none;">
                <h3>‚è≥ Pending Requests</h3>
                <div class="pending-requests" id="pendingRequestsContainer"></div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Main Tabletop Area -->
        <div class="main-area">
            <div class="tabletop">
                <div class="tabletop-header">
                    <div class="session-name">Session Map</div>
                    <div class="zoom-controls">
                        <span style="font-size: 0.85rem; color: var(--text-dim);">Zoom:</span>
                        <input type="range" id="zoomSlider" class="slider" min="10" max="300" value="100" oninput="setZoom(this.value)">
                        <span id="zoomValue" style="font-size: 0.85rem; min-width: 50px;">100%</span>
                        <button class="btn btn-small" onclick="resetView()">Reset</button>
                    </div>
                </div>
                <div class="canvas-container">
                    <canvas id="mainCanvas"></canvas>
                    
                    <!-- Token Staging Zone -->
                    <div class="staging-zone" id="stagingZone" style="display: none;">
                        <div class="staging-label">Tokens</div>
                        <div class="staging-tokens" id="stagingTokensContainer"></div>
                        <button class="btn btn-small" onclick="openTokenCreator()">+ Add</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DM Panel -->
        <div class="dm-panel" id="dmPanel">
            <div class="dm-header">
                <h2>üé≠ DM Controls</h2>
                <button class="btn btn-small" onclick="toggleDMPanel()">‚úï</button>
            </div>
            <div class="dm-content">
                
                <!-- Grid Navigation -->
                <div class="section">
                    <h3>üó∫Ô∏è Grid Navigation</h3>
                    <div class="grid-selector">
                        <div class="grid-info">
                            Current Cell: <span id="currentGridDisplay" class="current">2, 2</span>
                        </div>
                        <div class="grid-nav">
                            <button class="btn" onclick="navigateGrid('left')">‚Üê</button>
                            <button class="btn" onclick="navigateGrid('up')">‚Üë</button>
                            <button class="btn" onclick="navigateGrid('right')">‚Üí</button>
                            <button class="btn" onclick="navigateGrid('left')">‚Üê</button>
                            <button class="btn" onclick="navigateGrid('center')">‚óè</button>
                            <button class="btn" onclick="navigateGrid('right')">‚Üí</button>
                            <button class="btn" onclick="navigateGrid('left')">‚Üê</button>
                            <button class="btn" onclick="navigateGrid('down')">‚Üì</button>
                            <button class="btn" onclick="navigateGrid('right')">‚Üí</button>
                        </div>
                        <div class="btn-group" style="margin-top: 0.75rem;">
                            <button class="btn btn-small" onclick="lockCurrentCell()">üîí Lock</button>
                            <button class="btn btn-small" onclick="unlockCurrentCell()">üîì Unlock</button>
                            <button class="btn btn-small btn-danger" onclick="clearCurrentCell()">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Drawing Tools -->
                <div class="section">
                    <h3>‚úèÔ∏è Drawing Tools</h3>
                    <div class="tool-grid">
                        <button class="tool-btn" data-mode="pen" onclick="setDrawMode('pen')">‚úèÔ∏è Pen</button>
                        <button class="tool-btn" data-mode="eraser" onclick="setDrawMode('eraser')">üßπ Erase</button>
                        <button class="tool-btn" data-mode="none" onclick="setDrawMode('none')">üö´ None</button>
                    </div>
                    <div class="control-row">
                        <label>Color:</label>
                        <input type="color" id="drawColor" value="#000000" onchange="setDrawColor(this.value)">
                    </div>
                    <div class="control-row">
                        <label>Width:</label>
                        <input type="range" min="1" max="50" value="5" oninput="setLineWidth(this.value)">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-small" onclick="undo()">‚Ü∂ Undo</button>
                        <button class="btn btn-small" onclick="redo()">‚Ü∑ Redo</button>
                    </div>
                </div>

                <!-- Map Builder -->
                <div class="section">
                    <h3>üñºÔ∏è Map Builder</h3>
                    <canvas id="mapCanvas"></canvas>
                    <div class="btn-group">
                        <button class="btn btn-small" onclick="clearMapCanvas()">Clear</button>
                        <button class="btn btn-small btn-primary" onclick="importMapToGrid()">Import to Grid</button>
                    </div>
                    <div class="btn-group" style="margin-top: 0.5rem;">
                        <button class="btn btn-small" onclick="uploadImage()">üìÅ Upload Image</button>
                        <button class="btn btn-small btn-danger" onclick="clearAllImages()">Clear All</button>
                    </div>
                </div>

                <!-- Fog of War -->
                <div class="section">
                    <h3>üå´Ô∏è Fog of War</h3>
                    <div class="fog-groups" id="fogGroupsContainer"></div>
                    <button class="btn btn-small" onclick="createFogGroup()" style="width: 100%; margin-bottom: 0.75rem;">+ New Group</button>
                    <div class="control-row">
                        <label>Mode:</label>
                        <select onchange="setFogMode(this.value)">
                            <option value="reveal">Reveal</option>
                            <option value="hide">Hide</option>
                        </select>
                    </div>
                    <div class="control-row">
                        <label>Brush:</label>
                        <input type="range" min="10" max="200" value="50" oninput="setFogBrushSize(this.value)">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-small" onclick="clearFogGroup(activeFogGroup)">Clear Fog</button>
                        <button class="btn btn-small" onclick="resetFogGroup(activeFogGroup)">Reset Fog</button>
                    </div>
                </div>

                <!-- Player Management -->
                <div class="section">
                    <h3>üë• Player Management</h3>
                    <div id="pendingRequestsContainer"></div>
                    <button class="btn btn-small" onclick="openTokenCreator()" style="width: 100%; margin-top: 0.5rem;">+ Add Token</button>
                    <button class="btn btn-small btn-danger" onclick="clearAllTokens()" style="width: 100%; margin-top: 0.5rem;">Clear All Tokens</button>
                </div>

                <!-- Session Controls -->
                <div class="section">
                    <h3>üíæ Session Controls</h3>
                    <button class="btn btn-small" onclick="toggleGridSnap()" id="gridSnapBtn" class="active" style="width: 100%; margin-bottom: 0.5rem;">üìê Snap: ON</button>
                    <button class="btn btn-small" onclick="exportSession()" style="width: 100%; margin-bottom: 0.5rem;">üíæ Export Session</button>
                    <button class="btn btn-small" onclick="importSession()" style="width: 100%;">üìÇ Import Session</button>
                    <div class="asset-indicator" style="margin-top: 1rem;">
                        Auto-save: <span class="current-asset">Every 30s</span>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Minimap Navigator -->
    <div class="minimap-container" id="minimapContainer">
        <div class="minimap" id="minimap">
            <div class="minimap-header">
                <div class="minimap-title">Grid Map</div>
                <div class="minimap-controls">
                    <button class="minimap-btn" onclick="toggleMinimap()">‚àí</button>
                    <button class="minimap-btn" onclick="dockMinimap()">‚ä°</button>
                </div>
            </div>
            <div class="minimap-content">
                <div class="minimap-grid" id="minimapGrid"></div>
                <div class="minimap-actions">
                    <button class="minimap-action-btn" onclick="navigateGrid('up')">‚Üë</button>
                    <button class="minimap-action-btn" onclick="navigateGrid('down')">‚Üì</button>
                    <button class="minimap-action-btn" onclick="navigateGrid('left')">‚Üê</button>
                    <button class="minimap-action-btn" onclick="navigateGrid('right')">‚Üí</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Files - Load in dependency order -->
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/networking.js"></script>
    <script src="js/canvas.js"></script>
    <script src="js/tokens.js"></script>
    <script src="js/dm-panel.js"></script>
    <script src="js/session-persistence.js"></script>
    <script src="js/minimap.js"></script>

</body>
</html>
